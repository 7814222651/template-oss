
name: CI

on:
  workflow_dispatch:
    inputs:
      all:
        type: boolean
  workflow_call:
    {{> partialsWorkflowCallInputs }}
      all:
        type: boolean
  pull_request:
    {{> partialsBranches }}
  push:
    {{> partialsBranches }}
  schedule:
    {{> partialsCron hour=2 }}

jobs:
  lint:
    name: Lint
    if: {{> partialsIfOrg }} && {{> partialsIfSkipPr }}
    {{> partialsJobDefaults }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: $\{{ inputs.ref }}

      {{> partialsCreateCheck name="Lint" }}

      - name: Setup
        id: setup
        uses: ./.github/actions/setup

      - name: Get Changed Workspaces
        id: workspaces
        uses: ./.github/actions/changed-workspaces
        with:
          token: $\{{ secrets.GITHUB_TOKEN }}
          files: $\{{ (inputs.all && '--all') || '' }}

      - name: Lint
        uses: ./.github/actions/lint
        with:
          flags: $\{{ steps.workspaces.outputs.flags }}

      {{> partialsConcludeCheck }}

  test:
    name: Test - $\{{ matrix.platform.name }} - $\{{ matrix.node-version }}
    if: {{> partialsIfOrg }} && {{> partialsIfSkipPr }}
    {{> partialsMatrixStrategy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: $\{{ inputs.ref }}

      {{> partialsCreateCheck name="Test - ${{ matrix.platform.name }} - ${{ matrix.node-version }}" }}

      - name: Continue Matrix Run
        id: continue-matrix
        shell: bash
        run: |
          if [[ "$\{{ matrix.node-version }}" == "{{ first ciVersions }}" || "$\{{ inputs.all }}" == "true" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup
        if: steps.continue-matrix.outputs.result
        uses: ./.github/actions/setup
        id: setup
        with:
          node-version: $\{{ matrix.node-version }}
          shell: $\{{ matrix.platform.shell }}

      - name: Get Changed Workspaces
        if: steps.continue-matrix.outputs.result
        id: workspaces
        uses: ./.github/actions/changed-workspaces
        with:
          token: $\{{ secrets.GITHUB_TOKEN }}
          files: $\{{ (inputs.all && '--all') || '' }}

      - name: Test
        if: steps.continue-matrix.outputs.result
        uses: ./.github/actions/test
        with:
          flags: $\{{ steps.workspaces.outputs.flags }}
          shell: $\{{ matrix.platform.shell }}

      {{> partialsConcludeCheck }}
